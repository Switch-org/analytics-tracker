name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed
    branches:
      - main
      - master

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run on main/master branch
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure git for semantic-release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Ensure we're using the correct repository URL
          git remote set-url origin https://github.com/Switch-org/analytics-tracker.git
          # Fetch all tags for semantic-release
          git fetch --tags --force

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Skip audit for dev dependencies (vulnerabilities are in semantic-release, npm itself)
          # These don't affect the published package
          npm ci --audit=false --fund=false

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Verify build output
        run: |
          ls -la dist/
          test -f dist/index.cjs.js
          test -f dist/index.esm.js
          test -f dist/index.d.ts
          test -f dist/index.d.cts

      - name: Configure npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Check if token is set
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ NPM_TOKEN secret is not set in GitHub repository settings"
            echo "Please go to Settings â†’ Secrets and variables â†’ Actions and add NPM_TOKEN"
            exit 1
          fi
          
          # Configure npm authentication
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          npm config set registry https://registry.npmjs.org/
          chmod 600 ~/.npmrc
          
          echo "âœ… npm authentication configured"

      - name: Verify npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸ” Testing npm authentication..."
          NPM_WHOAMI_OUT=$(npm whoami 2>&1) || true
          NPM_EXIT=$?
          if [ $NPM_EXIT -ne 0 ]; then
            echo "âŒ npm authentication failed!"
            echo ""
            echo "npm output: $NPM_WHOAMI_OUT"
            echo ""
            echo "Fix:"
            echo "1. Create an npm Automation token: https://www.npmjs.com/settings/~/tokens â†’ Generate New Token â†’ Automation"
            echo "2. Copy the token (starts with npm_)"
            echo "3. GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo "4. Name: NPM_TOKEN (exact). Value: paste the token. Add secret."
            echo "5. If the token exists: regenerate it (old one may be expired) and update the NPM_TOKEN secret."
            echo ""
            echo "Token must be type Automation (not Classic) and have publish access."
            exit 1
          fi
          NPM_USER="$NPM_WHOAMI_OUT"
          echo "âœ… npm authentication successful"
          echo "ðŸ“¦ Logged in as: $NPM_USER"
          
          # Check package ownership
          PACKAGE_NAME="user-analytics-tracker"
          echo "ðŸ” Checking package ownership for: $PACKAGE_NAME"
          
          # Try to check if package exists and who owns it
          PACKAGE_INFO=$(npm view $PACKAGE_NAME maintainers 2>&1 || echo "package_not_found")
          if [[ "$PACKAGE_INFO" == *"package_not_found"* ]] || [[ "$PACKAGE_INFO" == *"404"* ]]; then
            echo "â„¹ï¸  Package $PACKAGE_NAME doesn't exist yet - will be created on first publish"
            echo "âœ… Token user ($NPM_USER) will become the owner"
          else
            echo "ðŸ“‹ Package maintainers:"
            echo "$PACKAGE_INFO"
            echo ""
            echo "âš ï¸  Make sure $NPM_USER is listed as a maintainer, or has publish access"
          fi
          
          # Verify token can publish (dry run)
          echo "ðŸ§ª Testing publish permissions (dry run)..."
          npm publish --dry-run --access public || echo "âš ï¸  Dry run completed with warnings"

      - name: Check package access before release
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGE_NAME="user-analytics-tracker"
          NPM_USER=$(npm whoami)
          echo "ðŸ“¦ Checking access to package: $PACKAGE_NAME"
          echo "ðŸ‘¤ npm user: $NPM_USER"
          
          # Check if package exists
          if npm view $PACKAGE_NAME version > /dev/null 2>&1; then
            echo "âœ… Package exists"
            echo "ðŸ“‹ Checking maintainers..."
            MAINTAINERS=$(npm view $PACKAGE_NAME maintainers 2>&1 || echo "")
            echo "$MAINTAINERS"
            
            if [[ "$MAINTAINERS" == *"$NPM_USER"* ]]; then
              echo "âœ… $NPM_USER is a maintainer - can publish"
            else
              echo "âŒ ERROR: $NPM_USER is NOT a maintainer of $PACKAGE_NAME"
              echo "ðŸ’¡ Solution: Add yourself as maintainer: npm owner add $NPM_USER $PACKAGE_NAME"
              echo "ðŸ’¡ Or use NPM_TOKEN from the package owner's account"
              exit 1
            fi
          else
            echo "â„¹ï¸  Package doesn't exist yet - will be created on first publish"
            echo "âœ… $NPM_USER will become the owner"
          fi

      - name: Debug semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸ” Debugging semantic-release configuration..."
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo "NPM_TOKEN: ${NPM_TOKEN:0:10}..."
          echo ""
          echo "Current branch: $(git branch --show-current)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Latest tag: $(git describe --tags --abbrev=0 2>/dev/null || echo 'No tags found')"
          echo ""
          echo "ðŸ“‹ Commits since last tag (or last 10 commits):"
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No tags found, showing last 10 commits:"
            git log --oneline -10 --no-merges
          else
            echo "Commits since $LAST_TAG:"
            git log --oneline ${LAST_TAG}..HEAD --no-merges
          fi
          echo ""
          echo "ðŸ“‹ All commits (including merges) since last tag:"
          if [ -z "$LAST_TAG" ]; then
            git log --oneline -10
          else
            git log --oneline ${LAST_TAG}..HEAD
          fi
          echo ""
          echo "ðŸ“¦ Package.json version: $(node -p "require('./package.json').version")"
          echo "ðŸ“¦ Package name: $(node -p "require('./package.json').name")"
          echo ""
          echo "ðŸ§ª Running semantic-release dry-run..."
          npx semantic-release --dry-run --debug || echo "âš ï¸  Dry-run completed"

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Ensure npm token is available to semantic-release
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
          npm run release
        continue-on-error: false
