name: Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run on main/master branch, not on forks
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Verify build output
        run: |
          ls -la dist/
          test -f dist/index.cjs.js
          test -f dist/index.esm.js
          test -f dist/index.d.ts
          test -f dist/index.d.cts

      - name: Configure npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Check if token is set
          if [ -z "$NPM_TOKEN" ]; then
            echo "‚ùå NPM_TOKEN secret is not set in GitHub repository settings"
            echo "Please go to Settings ‚Üí Secrets and variables ‚Üí Actions and add NPM_TOKEN"
            exit 1
          fi
          
          # Configure npm authentication
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          npm config set registry https://registry.npmjs.org/
          chmod 600 ~/.npmrc
          
          echo "‚úÖ npm authentication configured"

      - name: Verify npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Test npm authentication
          NPM_USER=$(npm whoami 2>&1) || (echo "‚ùå npm authentication failed!" && echo "Check:" && echo "1. NPM_TOKEN is set in GitHub Secrets" && echo "2. Token has publish permissions" && echo "3. Token is valid and not expired" && exit 1)
          echo "‚úÖ npm authentication successful"
          echo "üì¶ Logged in as: $NPM_USER"
          
          # Check package ownership
          PACKAGE_NAME="user-analytics-tracker"
          echo "üîç Checking package ownership for: $PACKAGE_NAME"
          
          # Try to check if package exists and who owns it
          PACKAGE_INFO=$(npm view $PACKAGE_NAME maintainers 2>&1 || echo "package_not_found")
          if [[ "$PACKAGE_INFO" == *"package_not_found"* ]] || [[ "$PACKAGE_INFO" == *"404"* ]]; then
            echo "‚ÑπÔ∏è  Package $PACKAGE_NAME doesn't exist yet - will be created on first publish"
            echo "‚úÖ Token user ($NPM_USER) will become the owner"
          else
            echo "üìã Package maintainers:"
            echo "$PACKAGE_INFO"
            echo ""
            echo "‚ö†Ô∏è  Make sure $NPM_USER is listed as a maintainer, or has publish access"
          fi
          
          # Verify token can publish (dry run)
          echo "üß™ Testing publish permissions (dry run)..."
          npm publish --dry-run --access public || echo "‚ö†Ô∏è  Dry run completed with warnings"

      - name: Check package access before release
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGE_NAME="user-analytics-tracker"
          NPM_USER=$(npm whoami)
          echo "üì¶ Checking access to package: $PACKAGE_NAME"
          echo "üë§ npm user: $NPM_USER"
          
          # Check if package exists
          if npm view $PACKAGE_NAME version > /dev/null 2>&1; then
            echo "‚úÖ Package exists"
            echo "üìã Checking maintainers..."
            MAINTAINERS=$(npm view $PACKAGE_NAME maintainers 2>&1 || echo "")
            echo "$MAINTAINERS"
            
            if [[ "$MAINTAINERS" == *"$NPM_USER"* ]]; then
              echo "‚úÖ $NPM_USER is a maintainer - can publish"
            else
              echo "‚ùå ERROR: $NPM_USER is NOT a maintainer of $PACKAGE_NAME"
              echo "üí° Solution: Add yourself as maintainer: npm owner add $NPM_USER $PACKAGE_NAME"
              echo "üí° Or use NPM_TOKEN from the package owner's account"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  Package doesn't exist yet - will be created on first publish"
            echo "‚úÖ $NPM_USER will become the owner"
          fi

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm run release
        continue-on-error: false
